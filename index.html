<!DOCTYPE html>
<html>

<head>
  <meta name='viewport' content='width=device-width, initial-scale=1.0' />
  <link rel='stylesheet' href='reset.css'>
  <link rel='stylesheet' href='style.css'>
  <title>Browser Adventure</title>
</head>


<body id='gameRoot'>

  <img id='themeImage' src='img/menu.jpg' alt='Background Image'>
  <br />
  <p id='themeDescription'></p>
  <br />

  <script>


    //=============== GAME ENGINE ===============//

    const gameState = {
      currentLocation: '',
      beersDrunk: 0,
      playerHealth: 0,
      playerMana: 0,
      playerDodgeChance: 0,
      playerClass: '',
      playerGold: 0,
      playerItems: []
    }

    const GameConstants = {
      startLocation: 'menu',
      startPlayerHealth: 100,
      startPlayerMana: 100,
      startPlayerDodgeChance: 10,
      startPlayerBeersDrunk: 0,
      startPlayerGold: 50,
      startPlayerItems: ['healthpotion'],
      beerPrice: 2
    }

    const UI = {
      setThemeImage: (image) => {
        const imageElement = document.getElementById('themeImage')
        imageElement.setAttribute('src', image)
      },
      setThemeButtons: (actions) => {
        // Clear existing buttons
        const existingButtons = Array.from(document.getElementsByClassName('action-button'))
        existingButtons.forEach(button => button.remove())

        // Find Root
        const bodyElement = document.getElementById('gameRoot')

        // Loop through actions
        actions.forEach(action => {
          const myButton = document.createElement('button')
          myButton.setAttribute('class', 'block action-button')
          myButton.innerHTML = action.label
          myButton.addEventListener('click', action.action)
          bodyElement.append(myButton)
        })
      },
      setThemeDescription: (description) => {
        document.getElementById('themeDescription').innerHTML = description
      },
      addToThemeDescription: (newDescription) => {
        var oldDesc = document.getElementById('themeDescription').innerHTML
        document.getElementById('themeDescription').innerHTML = oldDesc + "<br>" + newDescription
      }
    }

    const GameManager = {
      setRoom: (room) => {
        Events.emit('RoomChanges', room)
      },
      setDescription: (description) => {
        Events.emit('DescriptionChanges', description)
      },
      addToDescription: (newDescription) => {
        Events.emit('DescriptionAdds', newDescription)
      }
    }


    //Event System
    class Events {
      static bus = {}

      static register(eventName, func) {
        const event = this.bus[eventName]
        if (!event) {
          this.bus[eventName] = []
        }
        this.bus[eventName].push(func)
      }

      static emit(eventName, ...params) {
        const event = this.bus[eventName]
        if (!event) {
          return
        }
        event.forEach(listener => {
          listener(...params)
        })
      }
    }



    Events.register("Drink", () => {
      gameState.beersDrunk += 1
    })

    Events.register("Drink", () => {
      gameState.playerGold -= GameConstants.beerPrice
    })

    Events.register("Drink", () => {
      GameManager.setDescription("Drinking beer #" + gameState.beersDrunk)
    })

    Events.register("Drink", () => {
      Events.emit("PrintPlayerGold")
      if (gameState.beersDrunk > 7) {
        Events.emit("PlayerGettingTipsy")
      }
      if (gameState.beersDrunk > 10) {
        Events.emit("PlayerTakesDamage", 10, "Alcohol")
      }
    })

    Events.register("PlayerGettingTipsy", () => {
      GameManager.addToDescription("You probably shouldn't drink any more...")
    })



    Events.register("PrintPlayerGold", () => {
      GameManager.addToDescription("You have " + gameState.playerGold + " gold left.")
      console.log(gameState.playerItems)
    })

    Events.register("PrintPlayerItems", () => {
      GameManager.setDescription("Player's inventory:")
      gameState.playerItems.forEach(playerItem => {
        GameManager.addToDescription(ItemTagDictionary[playerItem].name)
      })

      //logging to console for testing
      console.log("Player's inventory:")
      gameState.playerItems.forEach(playerItem => {
        console.log(ItemTagDictionary[playerItem])
      })
    })

    Events.register("PlayerDeath", (deathReason) => {
      GameManager.setRoom(gameWorld.death)
      if (deathReason) {
        UI.addToThemeDescription("You were killed by: " + deathReason)
      }
    })

    Events.register("NewGame", () => {
      gameState.beersDrunk = GameConstants.startPlayerBeersDrunk
      gameState.playerHealth = GameConstants.startPlayerHealth
      gameState.playerMana = GameConstants.startPlayerMana
      gameState.playerGold = GameConstants.startPlayerGold
      gameState.playerItems = GameConstants.startPlayerItems.map(a => a)
    })

    Events.register("PlayerTakesDamage", (damage, damageReason) => {
      gameState.playerHealth -= damage
      console.log("HP = " + gameState.playerHealth)
      if (gameState.playerHealth < 1) {
        Events.emit("PlayerDeath", damageReason)
      }
    })

    Events.register("RoomChanges", (room) => {
      UI.setThemeImage(room.image)
      UI.setThemeButtons(room.actions)
      UI.setThemeDescription(room.description)
      gameState.currentLocation = room
    })

    Events.register("DescriptionChanges", (description) => {
      UI.setThemeDescription(description)
    })

    Events.register("DescriptionAdds", (newDescription) => {
      UI.addToThemeDescription(newDescription)
    })

    function create(itemTag, options = {}) {
      return {
        ...ItemTagDictionary[itemTag],
        ...options
      }
    }

    function getLootRoll(entity) {
      const roll = Math.random()
      const succesfulLoot = entity.lootTable.filter(lootOption => lootOption.chance >= roll)
      return succesfulLoot.map(lootOption => lootOption.item)
    }



    //=============== ITEMS AND ENEMIES STATS ===============//

    const ItemTagDictionary = {
      //--ITEMS--//
      bronzedagger: {
        name: "Bronze dagger",
        damage: 3,
        value: 3,
        weight: 1
      },
      bronzesword: {
        name: "Bronze sword",
        damage: 5,
        value: 5,
        weight: 2
      },
      irondagger: {
        name: "Iron dagger",
        damage: 8,
        value: 8,
        weight: 1
      },
      ironsword: {
        name: "Iron sword",
        damage: 10,
        value: 10,
        weight: 3,
      },
      staff: {
        name: "Staff",
        damage: 3,
        value: 5,
        weight: 3
      },
      clotharmor: {
        name: "Cloth armor",
        armor: 2,
        value: 10,
        weight: 1.5,
      },
      leatherarmor: {
        name: "Leather armor",
        armor: 5,
        value: 10,
        weight: 3
      },
      ironarmor: {
        name: "Iron armor",
        armor: 10,
        value: 20,
        weight: 10
      },
      healthpotion: {
        name: "Health potion",
        value: 15,
        weight: 0.5,
      },
      bones: {
        name: "Bones",
        value: 1,
        weight: 5,
      },
      batbones: {
        name: "Bat bones",
        value: 5,
        weight: 1
      },
      spidercarcass: {
        name: "Spider carcass",
        value: 2,
        weight: 2
      },
      spidervenom: {
        name: "Spider venom",
        value: 10,
        weight: 1
      },

      //--MONSTERS--//
      skeleton: {
        name: "Skeleton",
        maxhealth: 50,
        weaponTag: 'bronzedagger',
        lootTable: [
          {
            itemTag: 'bones',
            dropchance: 1.00
          },
          {
            itemTag: 'ironsword',
            dropchance: 0.90
          }
        ]
      },
      giantspider: {
        name: "Giant Spider",
        maxhealth: 30,
        maxmana: 10,
        lootTable: [
          {
            itemTag: "spidercarcass",
            dropchance: 1.00
          },
          {
            itemTag: "spidervenom",
            dropchance: 0.5
          }
        ]
      },
      goblin: {
        name: "Goblin",
        maxhealth: 20,
        maxmana: 5,
        lootTable: [
          {
            itemTag: 'bones',
            dropchance: 1.00
          },
        ]
      },
      vampire: {
        name: "Vampire",
        maxhealth: 70,
        maxmana: 50,
        lootTable: [
          {
            itemTag: 'batbones',
            dropchance: 1.00
          },
        ]
      },
    }



    //example for creating an enemy
    const skeleton1 = create('skeleton', {
      health: 44,
      weapon: 'ironsword',
      lootTable: [
        {
          name: 'healthpotion',
          dropchance: 0.5
        }
      ]
    })

    //example for enemy dropping loot
    const lootFromSkeleton1 = getLootRoll(skeleton1)




    //TODO: Combat system, inventory system, healing food/potions
    //TODO: Improve class system
    //TODO: Shops, currency

    //=============== ROOMS ===============//
    const gameWorld = {
      menu: {
        image: 'img/menu.jpg',
        description: "Welcome to Browser Adventure!",
        actions: [
          {
            label: "New game",
            action: () => {
              Events.emit('NewGame')
              GameManager.setRoom(gameWorld.chooseclass)
            }
          },
          {
            label: "Load game",
            action: () => {
              GameManager.setDescription("Sorry, loading a game doesn't work yet!")
            }
          },
          {
            label: "Options",
            action: () => {
              GameManager.setDescription("Sorry, there's no options yet!")
            }
          },
          {
            label: "Credits",
            action: () => {
              GameManager.setRoom(gameWorld.credits)
            }
          },
          {
            label: "Exit",
            action: () => closeWindow()
          }
        ]
      },
      chooseclass: {
        image: 'img/chooseclass.jpg',
        description: "Choose a class! <br/><br/> Warriors have more health, Rogues have a higher dodge chance, and Wizards have more mana.",
        actions: [
          {
            label: "Warrior",
            action: () => {
              gameState.playerClass = 'warrior'
              gameState.playerHealth *= 1.5
              gameState.playerMana *= 0.5
              gameState.playerItems.push('ironsword')
              gameState.playerItems.push('ironarmor')
              //TODO: parry/block chance
              GameManager.setRoom(gameWorld.playerhome)
            }
          },
          {
            label: "Rogue",
            action: () => {
              gameState.playerClass = 'rogue'
              gameState.playerHealth *= 1
              gameState.playerMana *= 0.7
              gameState.playerDodgeChance *= 2
              gameState.playerItems.push('irondagger')
              gameState.playerItems.push('leatherarmor')
              GameManager.setRoom(gameWorld.playerhome)
            }
          },
          {
            label: "Wizard",
            action: () => {
              gameState.playerClass = 'wizard'
              gameState.playerHealth *= 0.9
              gameState.playerMana *= 2
              gameState.playerItems.push('staff')
              gameState.playerItems.push('clotharmor')
              GameManager.setRoom(gameWorld.playerhome)
            }
          }
        ]
      },
      credits: {
        image: 'img/credits.jpg',
        description: "Thanks for playing! -Santeri",
        actions: [
          {
            label: "Back to Main Menu",
            action: () => GameManager.setRoom(gameWorld.menu)
          }
        ]
      },
      death: {
        image: 'img/death.jpg',
        description: "Oh dear, you're dead! Learn to play, noob.",
        actions: [
          {
            label: "Back to Main Menu",
            action: () => GameManager.setRoom(gameWorld.menu)
          }
        ]
      },
      playerhome: {
        image: 'img/playerhome1.png',
        description: "You're at the entrance of your home. <br>"
        + "You can see the kitchen ahead, and there's a set of stairs leading to the bedroom.",
        actions: [
          {
            label: "Go to the kitchen",
            action: () => {
              GameManager.setRoom(gameWorld.playerhome_kitchen)
            }
          },
          {
            label: "Go to the bedroom",
            action: () => {
              GameManager.setRoom(gameWorld.playerhome_bedroom)
            }
          },
          {
            label: "Look around",
            action: () => {
              GameManager.setDescription(gameWorld.playerhome.description)
            }
          },
          {
            label: "Leave",
            action: () => {
              GameManager.setRoom(gameWorld.townsquare)
            }
          },
          {
            label: "Inventory",
            action: () => Events.emit('PrintPlayerItems')
          },
          {
            label: "Save & Quit",
            action: () => GameManager.setRoom(gameWorld.menu)
          }
        ]
      },
      playerhome_kitchen: {
        image: 'img/playerhome_kitchen.png',
        description: "You're in your kitchen. <br>"
        + "There's some food left on the table. Your home's entrance is behind you.",
        actions: [
          {
            label: "Eat some food",
            action: () => {
              //
            }
          },
          {
            label: "Go back to the entrance",
            action: () => {
              GameManager.setRoom(gameWorld.playerhome)
            }
          },
          {
            label: "Look around",
            action: () => {
              GameManager.setDescription(gameWorld.playerhome_kitchen.description)
            }
          },
          {
            label: "Inventory",
            action: () => Events.emit('PrintPlayerItems')
          },
          {
            label: "Save & Quit",
            action: () => GameManager.setRoom(gameWorld.menu)
          }
        ]
      },
      playerhome_bedroom: {
        image: 'img/playerhome_bedroom.png',
        description: "You're upstairs in your bedroom. <br>"
        + "The bed looks comfy. There's stairs behind you leading back to the entrance of your home.",
        actions: [
          {
            label: "Go to sleep",
            action: () => {
              //
            }
          },
          {
            label: "Go back downstairs",
            action: () => {
              GameManager.setRoom(gameWorld.playerhome)
            }
          },
          {
            label: "Look around",
            action: () => {
              GameManager.setDescription(gameWorld.playerhome_bedroom.description)
            }
          },
          {
            label: "Inventory",
            action: () => Events.emit('PrintPlayerItems')
          },
          {
            label: "Save & Quit",
            action: () => GameManager.setRoom(gameWorld.menu)
          }
        ]
      },
      townsquare: {
        image: 'img/townsquare1.png',
        description: "You're at the town square. <br>"
        + "Your home is behind you. There's a bar next to you. There's a path leading out of town.",
        actions: [
          {
            label: "Go for a drink at the bar",
            action: () => {
              GameManager.setRoom(gameWorld.bar)
            }
          },
          {
            label: "Go home",
            action: () => {
              GameManager.setRoom(gameWorld.playerHome)
            }
          },
          {
            label: "Look around",
            action: () => {
              GameManager.setDescription(gameWorld.townsquare.description)
            }
          },
          {
            label: "Leave town",
            action: () => {
              GameManager.setRoom(gameWorld.forest)
            }
          },
          {
            label: "Inventory",
            action: () => Events.emit('PrintPlayerItems')
          },
          {
            label: "Save & Quit",
            action: () => GameManager.setRoom(gameWorld.menu)
          }
        ]
      },
      bar: {
        image: 'img/bar1.png',
        description: "You're at a local bar.",
        actions: [
          {
            label: "Buy a Beer (" + GameConstants.beerPrice + " gold)",
            action: () => {
              //checking if player has enough gold
              if (gameState.playerGold >= GameConstants.beerPrice) {
                Events.emit('Drink')
              }
              else {
                GameManager.setDescription("You can't afford that!")
              }
            }
          },
          {
            label: "Shout at bartender",
            action: () => {
              GameManager.setDescription("You yell: &quot;Oi! What arr ye lookin' at!&quot; <br> The man doesn't seem to like it...")
            }
          },
          {
            label: "Look around",
            action: () => {
              GameManager.setDescription(gameWorld.bar.description)
            }
          },
          {
            label: "Leave Bar",
            action: () => {
              GameManager.setRoom(gameWorld.townsquare)
            }
          },
          {
            label: "Inventory",
            action: () => Events.emit('PrintPlayerItems')
          },
          {
            label: "Save & Quit",
            action: () => GameManager.setRoom(gameWorld.menu)
          }
        ]
      },
      forest: {
        image: 'img/forest_clear.png',
        description: "You're in a forest. <br>"
        + "A path leads to a nearby town, and another deeper into the forest. You can also hear a river nearby. ",
        actions: [
          {
            label: "Explore deeper into the forest",
            action: () => {
              GameManager.setRoom(gameWorld.forest_fog)
            }
          },
          {
            label: "Go to the river",
            action: () => {
              GameManager.setRoom(gameWorld.river)
            }
          },
          {
            label: "Look around",
            action: () => {
              GameManager.setDescription(gameWorld.forest.description)
            }
          },
          {
            label: "Enter town",
            action: () => {
              GameManager.setRoom(gameWorld.townsquare)
            }
          },
          {
            label: "Inventory",
            action: () => Events.emit('PrintPlayerItems')
          },
          {
            label: "Save & Quit",
            action: () => GameManager.setRoom(gameWorld.menu)
          }
        ]
      },
      forest_fog: {
        image: 'img/forest_fog.png',
        description: "You're in a forest. It looks foggy and ominous here... <br>"
        + "A path leads back to the forest's edge, and another even deeper into the forest. ",
        actions: [
          {
            label: "Explore even deeper",
            action: () => {
              GameManager.setRoom(gameWorld.cabin)
            }
          },
          {
            label: "Go back to the forest's edge",
            action: () => {
              GameManager.setRoom(gameWorld.forest)
            }
          },
          {
            label: "Look around",
            action: () => {
              GameManager.setDescription(gameWorld.forest_fog.description)
            }
          },
          {
            label: "Inventory",
            action: () => Events.emit('PrintPlayerItems')
          },
          {
            label: "Save & Quit",
            action: () => GameManager.setRoom(gameWorld.menu)
          }
        ]
      },
      cabin: {
        image: 'img/cabin.png',
        description: "You find a creepy cabin in the middle of the woods... <br>"
        + "You can enter the cabin or leave.",
        actions: [
          {
            label: "Enter cabin",
            action: () => {
              GameManager.setRoom(gameWorld.cabin_inside)
            }
          },
          {
            label: "Leave",
            action: () => {
              GameManager.setRoom(gameWorld.forest_fog)
            }
          },
          {
            label: "Look around",
            action: () => {
              GameManager.setDescription(gameWorld.cabin.description)
            }
          },
          {
            label: "Inventory",
            action: () => Events.emit('PrintPlayerItems')
          },
          {
            label: "Save & Quit",
            action: () => GameManager.setRoom(gameWorld.menu)
          }
        ]
      },
      cabin_inside: {
        image: 'img/cabin_inside.png',
        description: "You abandoned all sense and entered the creepy cabin in the woods. <br>"
        + "There's a body laying on a bed. You're not sure if it's dead or alive...",
        actions: [
          {
            label: "Poke the body",
            action: () => {
              Events.emit("PlayerDeath", "Bloodthirsty vampire!")
            }
          },
          {
            label: "Run for your life!",
            action: () => {
              GameManager.setRoom(gameWorld.forest)
            }
          },
          {
            label: "Look around",
            action: () => {
              GameManager.setDescription(gameWorld.cabin_inside.description)
            }
          },
          {
            label: "Inventory",
            action: () => Events.emit('PrintPlayerItems')
          },
          {
            label: "Save & Quit",
            action: () => GameManager.setRoom(gameWorld.menu)
          }
        ]
      },
      river: {
        image: 'img/river.png',
        description: "You're at the bank of a flowing river. <br>"
        + "You can see a snowy forest far ahead of you. There's also a clear forest behind you leading into a town.",
        actions: [
          {
            label: "Go to snowy forest",
            action: () => {
              GameManager.setRoom(snowforest)
            }
          },
          {
            label: "Look around",
            action: () => {
              GameManager.setDescription(gameWorld.river.description)
            }
          },
          {
            label: "Go to the clear forest",
            action: () => {
              GameManager.setRoom(gameWorld.forest)
            }
          },
          {
            label: "Inventory",
            action: () => Events.emit('PrintPlayerItems')
          },
          {
            label: "Save & Quit",
            action: () => GameManager.setRoom(gameWorld.menu)
          }
        ]
      }
    }

    function startGame() {
      GameManager.setRoom(gameWorld[GameConstants.startLocation])
    }

    function closeWindow() {
      if (confirm("Exit Browser Adventure?")) {
        window.close()
      }
    }

    document.onload = startGame();

  </script>

  <noscript>Sorry, your browser does not support JavaScript!</noscript>

</body>

</html>