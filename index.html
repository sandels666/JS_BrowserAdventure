<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="reset.css">
  <link rel="stylesheet" href="style.css">
  <title>Browser Adventure</title>
</head>


<body id="gameRoot">

  <!--<p id="welcome">Welcome to Browser Adventure!</p> -->

  <img id="themeImage" src="img/menu.jpg" alt="Background Image">
  <br />
  <p id="themeDescription"></p>
  <br />

  <script>


    //=============== GAME ENGINE ===============//

    const gameState = {
      currentLocation: '',
      beersDrunk: 0,
      playerHealth: 0,
      playerMana: 0,
      playerDodgeChance: 0,
      playerClass: ''
    }

    const GameConstants = {
      startLocation: 'menu',
      startPlayerHealth: 100,
      startPlayerMana: 100,
      startPlayerDodgeChance: 10,
      startPlayerBeersDrunk: 0
    }

    const UI = {
      setThemeImage: (image) => {
        const imageElement = document.getElementById('themeImage')
        imageElement.setAttribute("src", image)
      },
      setThemeButtons: (actions) => {
        // Clear existing buttons
        const existingButtons = Array.from(document.getElementsByClassName('action-button'))
        existingButtons.forEach(button => button.remove())

        // Find Root
        const bodyElement = document.getElementById("gameRoot")

        // Loop through actions
        actions.forEach(action => {
          const myButton = document.createElement('button')
          myButton.setAttribute("class", "block action-button")
          myButton.innerHTML = action.label
          myButton.addEventListener('click', action.action)
          bodyElement.append(myButton)
        })
      },
      setThemeDescription: (description) => {
        document.getElementById('themeDescription').innerHTML = description
      },
      addToThemeDescription: (newDescription) => {
        var oldDesc = document.getElementById('themeDescription').innerHTML
        document.getElementById('themeDescription').innerHTML = oldDesc + "<br>" + newDescription
      }
    }

    const GameManager = {
      setRoom: (room) => {
        Events.emit("RoomChanges", room)
      },
      setDescription: (description) => {
        Events.emit("DescriptionChanges", description)
      },
      addToDescription: (newDescription) => {
        Events.emit("DescriptionAdds", newDescription)
      }
    }


    //Event System
    class Events {
      static bus = {}

      static register(eventName, func) {
        const event = this.bus[eventName]
        if (!event) {
          this.bus[eventName] = []
        }
        this.bus[eventName].push(func)
      }

      static emit(eventName, ...params) {
        const event = this.bus[eventName]
        if (!event) {
          return
        }
        event.forEach(listener => {
          listener(...params)
        })
      }
    }



    Events.register("Drink", () => {
      gameState.beersDrunk += 1
    })

    Events.register("Drink", () => {
      GameManager.setDescription('Drinking beer #' + gameState.beersDrunk)
    })

    Events.register("Drink", () => {
      if (gameState.beersDrunk > 7) {
        Events.emit("PlayerGettingTipsy")
      }
      if (gameState.beersDrunk > 10) {
        Events.emit("PlayerTakesDamage", 10)
      }
    })

    Events.register("PlayerGettingTipsy", () => {
      GameManager.addToDescription("You probably shouldn't drink any more...")
    })



    Events.register("PlayerDeath", () => {
      GameManager.setRoom(gameWorld.death)
    })

    Events.register("NewGame", () => {
      gameState.beersDrunk = GameConstants.startPlayerBeersDrunk
      gameState.playerHealth = GameConstants.startPlayerHealth
    })

    Events.register("PlayerTakesDamage", (damage) => {
      gameState.playerHealth -= damage
      console.log("HP = " + gameState.playerHealth)
        if (gameState.playerHealth < 1){
          Events.emit("PlayerDeath")
        }
    })

    Events.register("RoomChanges", (room) => {
      UI.setThemeImage(room.image)
      UI.setThemeButtons(room.actions)
      UI.setThemeDescription(room.description)
      gameState.currentLocation = room
    })

    Events.register("DescriptionChanges", (description) => {
      UI.setThemeDescription(description)
    })

    Events.register("DescriptionAdds", (newDescription) => {
      UI.addToThemeDescription(newDescription)
    })




    //=============== GAMEPLAY STUFF ===============//
    //TODO: Combat system, inventory system, weapons, healing food/potions
    //TODO: Improve class system
    const gameWorld = {
      menu: {
        image: "img/menu.jpg",
        description: "Welcome to Browser Adventure!",
        actions: [
          {
            label: 'New game',
            action: () => {
              Events.emit("NewGame")
              GameManager.setRoom(gameWorld.chooseclass)
            }
          },
          {
            label: 'Load game',
            action: () => {
              console.log("just kidding, saving and loading aren't implemented yet")
            }
          },
          {
            label: 'Options',
            action: () => {
              console.log("just kidding, no options either")
            }
          },
          {
            label: 'Credits',
            action: () => {
              GameManager.setRoom(gameWorld.credits)
            }
          },
          {
            label: 'Exit',
            action: () => closeWindow()
          }
        ]
      },
      chooseclass: {
        image: "img/chooseclass.jpg",
        description: "Choose a class! <br/><br/> Warriors have more health, Rogues have a higher dodge chance, and Wizards have more mana.",
        actions: [
          {
            label: 'Warrior',
            action: () => {
              gameState.playerClass = "warrior"
              gameState.playerHealth = GameConstants.startPlayerHealth * 1.5
              gameState.playerMana = GameConstants.startPlayerMana * 0.5
              //TODO: warrior gear, parry/block chance
              GameManager.setRoom(gameWorld.bar)
            }
          },
          {
            label: 'Rogue',
            action: () => {
              gameState.playerClass = "rogue"
              gameState.playerHealth = GameConstants.startPlayerHealth * 1
              gameState.playerMana = GameConstants.startPlayerMana * 0.7
              gameState.playerDodgeChance = GameConstants.startPlayerDodgeChance * 2
              //TODO: rogue gear
              GameManager.setRoom(gameWorld.bar)
            }
          },
          {
            label: 'Wizard',
            action: () => {
              gameState.playerClass = "wizard"
              gameState.playerHealth = GameConstants.startPlayerHealth * 0.9
              gameState.playerMana = GameConstants.startPlayerMana * 2
              //TODO: wizard gear
              GameManager.setRoom(gameWorld.bar)
            }
          }
        ]
      },
      credits: {
        image: "img/credits.jpg",
        description: "Thanks for playing! -Santeri",
        actions: [
          {
            label: 'Back to Main Menu',
            action: () => GameManager.setRoom(gameWorld.menu)
          }
        ]
      },
      death: {
        image: "img/death.jpg",
        description: "Oh dear, you're dead! Learn to play, noob.",
        actions: [
          {
            label: 'Back to Main Menu',
            action: () => GameManager.setRoom(gameWorld.menu)
          }
        ]
      },
      bar: {
        image: "img/bar.jpg",
        description: "You're sitting at a local bar.",
        actions: [
          {
            label: 'Drink a Beer',
            action: () => Events.emit('Drink')
          },
          {
            label: 'Shout at Man',
            action: () => {
              GameManager.setDescription("You yell: &quot;Oi! What arr ye lookin' at!&quot; <br> The man doesn't seem to like it...")
            }
          },
          {
            label: 'Look around',
            action: () => {
              GameManager.setDescription(gameWorld.bar.description)
            }
          },
          {
            label: 'Leave Bar',
            action: () => {
              GameManager.setRoom(gameWorld.townsquare)
            }
          },
          {
            label: 'Save & Quit',
            action: () => GameManager.setRoom(gameWorld.menu)
          }
        ]
      },
      townsquare: {
        image: "img/townsquare.jpg",
        description: "You're at the town square. There's a bar next to you, and a path leading out of town.",
        actions: [
          {
            label: 'Go for a drink',
            action: () => {
              GameManager.setRoom(gameWorld.bar)
            }
          },
          {
            label: 'Look around',
            action: () => {
              GameManager.setDescription(gameWorld.townsquare.description)
            }
          },
          {
            label: 'Leave town',
            action: () => {
              GameManager.setRoom(gameWorld.forest)
            }
          },
          {
            label: 'Save & Quit',
            action: () => GameManager.setRoom(gameWorld.menu)
          }
        ]
      },
      forest: {
        image: "img/forest.jpg",
        description: "You're in a forest. A path leads to a nearby town, and another deeper into the forest.",
        actions: [
          {
            label: 'Explore deeper',
            action: () => {
              GameManager.setRoom(gameWorld.deepforest)
            }
          },
          {
            label: 'Look around',
            action: () => {
              GameManager.setDescription(gameWorld.forest.description)
            }
          },
          {
            label: 'Enter town',
            action: () => {
              GameManager.setRoom(gameWorld.townsquare)
            }
          },
          {
            label: 'Save & Quit',
            action: () => GameManager.setRoom(gameWorld.menu)
          }
        ]
      },
      deepforest: {
        image: "img/deepforest.jpg",
        description: "You're in a dark, ominous forest. Maybe you should turn back...",
        actions: [
          {
            label: 'Explore even deeper...',
            action: () => Events.emit("PlayerDeath")
          },
          {
            label: 'Look around',
            action: () => {
              GameManager.setDescription(gameWorld.deepforest.description)
            }
          },
          {
            label: 'Go back to safety',
            action: () => {
              GameManager.setRoom(gameWorld.forest)
            }
          },
          {
            label: 'Save & Quit',
            action: () => GameManager.setRoom(gameWorld.menu)
          }
        ]
      }
    }

    function startGame() {
      GameManager.setRoom(gameWorld[GameConstants.startLocation])
    }

    function closeWindow() {
      if (confirm("Exit Browser Adventure?")) {
        window.close()
      }
    }

    document.onload = startGame();

  </script>

  <noscript>Sorry, your browser does not support JavaScript!</noscript>

</body>

</html>